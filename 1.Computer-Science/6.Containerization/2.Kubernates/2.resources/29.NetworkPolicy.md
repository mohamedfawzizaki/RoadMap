___________________________________________________________________________________________________________________________

---

# What is a NetworkPolicy?

* A **NetworkPolicy** is a Kubernetes resource that defines rules for **allowing or denying network traffic** to and from pods.
* It operates at the **network layer (OSI Layer 3/4)**, controlling which pods can communicate with each other and with external endpoints.
* Itâ€™s implemented by the cluster network plugin (CNI), e.g., Calico, Cilium, Weave Net.

---

# Why use NetworkPolicy?

* Secure your cluster by enforcing **pod-level network segmentation**.
* Limit which pods can access services.
* Control ingress and egress traffic flows.
* Prevent unauthorized access and lateral movement in multi-tenant clusters.

---

# NetworkPolicy Basics

* **Namespace-scoped resource**: applies to pods in a specific namespace.
* By default, if no NetworkPolicy applies, **all traffic is allowed**.
* Once any NetworkPolicy selects a pod, the default is to **deny all traffic that is not explicitly allowed**.
* You must explicitly define ingress and/or egress rules for allowed traffic.

---

# NetworkPolicy API Version and Kind

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
```

---

# Anatomy of a NetworkPolicy

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: example-networkpolicy
  namespace: default
spec:
  podSelector:
    matchLabels:
      role: backend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          role: frontend
    ports:
    - protocol: TCP
      port: 6379
  egress:
  - to:
    - ipBlock:
        cidr: 10.0.0.0/24
        except:
        - 10.0.0.5/32
    ports:
    - protocol: TCP
      port: 53
```

---

# Key Fields Explained

| Field                | Description                                                               |
| -------------------- | ------------------------------------------------------------------------- |
| `metadata.namespace` | Namespace the policy applies to                                           |
| `spec.podSelector`   | Selects pods this policy applies to (empty selects all pods in namespace) |
| `spec.policyTypes`   | List of policy types: `Ingress`, `Egress`, or both                        |
| `spec.ingress`       | List of ingress rules defining allowed incoming traffic                   |
| `spec.egress`        | List of egress rules defining allowed outgoing traffic                    |

---

# PodSelector

* Defines the set of pods this NetworkPolicy applies to within the namespace.
* Example:

```yaml
podSelector:
  matchLabels:
    role: backend
```

* Empty selector (`{}`) matches all pods in the namespace.

---

# PolicyTypes

* Controls which traffic directions are affected.
* Values:

  * `Ingress`: controls incoming traffic to selected pods.
  * `Egress`: controls outgoing traffic from selected pods.
* If omitted, defaults to `Ingress` only.

---

# Ingress Rules (`spec.ingress`)

* Define allowed incoming connections.
* Each ingress rule can specify:

  * **From**:

    * `podSelector`: allow traffic from pods with matching labels in the same namespace.
    * `namespaceSelector`: allow traffic from pods in namespaces matching labels.
    * `ipBlock`: allow traffic from specific CIDR IP ranges.
  * **Ports**:

    * Protocol and port number to allow.

Example:

```yaml
ingress:
- from:
  - podSelector:
      matchLabels:
        role: frontend
  ports:
  - protocol: TCP
    port: 6379
```

---

# Egress Rules (`spec.egress`)

* Define allowed outgoing connections.
* Structure similar to ingress, but specifies allowed destinations.

Example:

```yaml
egress:
- to:
  - ipBlock:
      cidr: 10.0.0.0/24
      except:
      - 10.0.0.5/32
  ports:
  - protocol: UDP
    port: 53
```

---

# IPBlock

* Defines a CIDR IP range for ingress or egress rules.
* Supports `except` to exclude specific IPs or subnets.
* Can be used to allow or deny external IP ranges.

---

# NamespaceSelector

* Allows traffic from pods in namespaces matching specified labels.

Example:

```yaml
from:
- namespaceSelector:
    matchLabels:
      environment: production
```

---

# Important Behavior Notes

* If **no NetworkPolicy selects a pod**, all traffic is allowed.
* Once a pod is selected by any NetworkPolicy, all traffic is **denied by default** except what is explicitly allowed.
* You can combine multiple NetworkPolicies for more complex rules.
* NetworkPolicies are **additive**; traffic allowed by any matching rule is permitted.

---

# Example Use Case: Allow Only Frontend to Access Backend Pods

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-policy
  namespace: default
spec:
  podSelector:
    matchLabels:
      role: backend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          role: frontend
    ports:
    - protocol: TCP
      port: 8080
```

* This policy restricts ingress to backend pods to only allow traffic from pods labeled `role=frontend` on TCP port 8080.

---

# Troubleshooting NetworkPolicies

* Verify the CNI plugin supports NetworkPolicies.
* Use `kubectl describe networkpolicy <name>` to check applied rules.
* Check pod labels and namespace labels used in selectors.
* Use tools like `kubectl exec` and `curl` or `telnet` to test connectivity.
* Inspect CNI logs for possible enforcement issues.

---

# Summary Table

| Concept           | Description                                                    |
| ----------------- | -------------------------------------------------------------- |
| NetworkPolicy     | Controls traffic flow to/from selected pods                    |
| podSelector       | Selects pods affected by the policy                            |
| policyTypes       | Ingress, Egress, or both                                       |
| ingress rules     | Allow incoming connections from pods, namespaces, or IP ranges |
| egress rules      | Allow outgoing connections to pods, namespaces, or IP ranges   |
| ipBlock           | CIDR IP ranges with optional exceptions                        |
| namespaceSelector | Selects namespaces for ingress/egress traffic                  |

---
