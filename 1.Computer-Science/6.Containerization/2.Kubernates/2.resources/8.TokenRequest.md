___________________________________________________________________________________________________________________________

---

## üîê What is a `TokenRequest`?

`TokenRequest` is a **Kubernetes API resource** that allows you to generate a **short-lived JWT access token** for a ServiceAccount.
It is the modern and secure way to get tokens for:

* Automation (CI/CD tools like Jenkins, GitHub Actions)
* Custom `kubeconfig` generation
* Internal app authentication

> Introduced in Kubernetes 1.12 and became default after 1.24.

---

## üîë Why `TokenRequest`?

| Traditional Method           | TokenRequest Method                     |
| ---------------------------- | --------------------------------------- |
| Used secrets (long-lived)    | Uses ephemeral, short-lived tokens      |
| Hard to revoke               | Easy to expire and rotate               |
| Automatically mounted in pod | Optional, request only when needed      |
| Less secure                  | More secure (aud, expiry, issuer, etc.) |

---

## üß± TokenRequest API Resource

```yaml
apiVersion: authentication.k8s.io/v1
kind: TokenRequest
metadata:
  name: my-token-request
spec:
  audiences:
    - https://kubernetes.default.svc
  expirationSeconds: 3600   # (optional, max 1 hour by default)
```

---

## üõ†Ô∏è How to Use `TokenRequest` to Generate a Token

### üîß Step-by-step (CLI)

```bash
kubectl create serviceaccount cicd-sa -n dev
```

Then generate a token for it:

```bash
kubectl -n dev create token cicd-sa --duration=1h
```

üí° Output:

```bash
eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ...
```

You can now use this token in:

* `curl` requests to Kubernetes API
* Custom `kubeconfig` generation

---

## üìÑ Full Example: Manual TokenRequest YAML

You can also create it directly as a manifest:

```yaml
apiVersion: authentication.k8s.io/v1
kind: TokenRequest
spec:
  audiences:
  - https://kubernetes.default.svc
  expirationSeconds: 1800
```

Then apply with:

```bash
kubectl create -f token-request.yaml
```

But normally, tokens are requested **programmatically** or via `kubectl create token`.

---

## üîê Fields of a Token

The token is a **JWT** (JSON Web Token), which includes:

| Claim | Description                                      |
| ----- | ------------------------------------------------ |
| `sub` | Identity (e.g., `system:serviceaccount:ns:name`) |
| `aud` | Audience (`https://kubernetes.default.svc`)      |
| `exp` | Expiration timestamp                             |
| `iss` | Token issuer (Kubernetes)                        |

---

## üìò Example Use Case: Generate Kubeconfig for a ServiceAccount

1. Generate the token:

```bash
kubectl -n dev create token cicd-sa --duration=1h
```

2. Get cluster info:

```bash
CLUSTER=$(kubectl config view --minify -o jsonpath='{.clusters[0].name}')
SERVER=$(kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}')
CA=$(kubectl config view --raw --minify -o jsonpath='{.clusters[0].cluster.certificate-authority-data}')
```

3. Create a kubeconfig:

```yaml
apiVersion: v1
kind: Config
clusters:
- cluster:
    certificate-authority-data: {{CA}}
    server: {{SERVER}}
  name: {{CLUSTER}}
contexts:
- context:
    cluster: {{CLUSTER}}
    namespace: dev
    user: cicd-sa
  name: cicd-context
current-context: cicd-context
users:
- name: cicd-sa
  user:
    token: {{TOKEN_FROM_TOKENREQUEST}}
```

Save and use this file with:

```bash
kubectl --kubeconfig=my-kubeconfig.yaml get pods -n dev
```

---

## üîÑ Token Rotation

* Tokens issued via `TokenRequest` are **short-lived** and **not auto-rotated**.
* It‚Äôs up to the **external system (CI/CD, script)** to refresh when needed.
* They are **not stored as Kubernetes secrets**, unlike legacy ServiceAccount tokens.

---

## üìå Security Considerations

| Best Practice                         | Reason                                      |
| ------------------------------------- | ------------------------------------------- |
| Use `TokenRequest` instead of secrets | Secrets are static and harder to revoke     |
| Set a small `expirationSeconds`       | Reduces window of misuse                    |
| Use audience (`aud`) to scope tokens  | Prevent token misuse outside Kubernetes API |
| Never store in Git or logs            | Treat like passwords                        |

---

## üß™ Debugging / Verification

Decode JWT token (optional):

```bash
echo "$TOKEN" | cut -d "." -f2 | base64 -d | jq
```

Check token claims like:

* `exp`, `sub`, `aud`

---

## ‚úÖ Summary

| Feature                    | TokenRequest (‚úÖ)                |
| -------------------------- | ------------------------------- |
| Short-lived                | Yes                             |
| Rotatable                  | Yes (request a new one)         |
| Secure                     | Yes (scoped to audience + time) |
| Native CLI Support         | Yes (`kubectl create token`)    |
| Better than legacy secrets | ‚úÖ 100% recommended after v1.24  |

---

Here‚Äôs a complete **script to generate a kubeconfig file using a `ServiceAccount` token via `TokenRequest`**, suitable for use in a **CI/CD pipeline** like Jenkins, GitHub Actions, or GitLab CI.

---

## üîß Script: Generate Kubeconfig for a ServiceAccount Token

### üìÅ `generate-kubeconfig.sh`

```bash
#!/bin/bash

# üö© CONFIGURATION
NAMESPACE=ci
SERVICE_ACCOUNT_NAME=ci-sa
KUBECONFIG_FILE=ci-sa.kubeconfig
TOKEN_DURATION="3600s"  # 1 hour

# üîç Get cluster information
CLUSTER_NAME=$(kubectl config view --minify -o jsonpath='{.clusters[0].name}')
CLUSTER_SERVER=$(kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}')
CLUSTER_CA=$(kubectl config view --raw --minify -o jsonpath='{.clusters[0].cluster.certificate-authority-data}')

# üõ† Create namespace and service account if they don‚Äôt exist
kubectl get ns $NAMESPACE >/dev/null 2>&1 || kubectl create ns $NAMESPACE
kubectl -n $NAMESPACE get sa $SERVICE_ACCOUNT_NAME >/dev/null 2>&1 || kubectl -n $NAMESPACE create sa $SERVICE_ACCOUNT_NAME

# ü™ô Request a token for the service account
SA_TOKEN=$(kubectl -n $NAMESPACE create token $SERVICE_ACCOUNT_NAME --duration=$TOKEN_DURATION)

# üìÑ Generate kubeconfig
cat <<EOF > $KUBECONFIG_FILE
apiVersion: v1
kind: Config
clusters:
- name: $CLUSTER_NAME
  cluster:
    server: $CLUSTER_SERVER
    certificate-authority-data: $CLUSTER_CA
contexts:
- name: $CLUSTER_NAME-context
  context:
    cluster: $CLUSTER_NAME
    namespace: $NAMESPACE
    user: $SERVICE_ACCOUNT_NAME
current-context: $CLUSTER_NAME-context
users:
- name: $SERVICE_ACCOUNT_NAME
  user:
    token: $SA_TOKEN
EOF

# ‚úÖ Done
echo "‚úÖ Kubeconfig file generated at: $KUBECONFIG_FILE"
```

---

## ‚úÖ Prerequisites

* You must have `kubectl` configured and authenticated with a cluster.
* Kubernetes version 1.24 or newer (which supports `TokenRequest`)
* RBAC permissions allowing the ServiceAccount to access needed resources.

---

## üß™ Optional: Add RBAC Access

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ci-access
roleRef:
  kind: ClusterRole
  name: cluster-admin  # üîí for full access ‚Äî replace with restricted role for security!
  apiGroup: rbac.authorization.k8s.io
subjects:
- kind: ServiceAccount
  name: ci-sa
  namespace: ci
```

Apply with:

```bash
kubectl apply -f ci-rbac.yaml
```

---

## üîê Use in CI/CD Example (GitHub Actions)

```yaml
- name: Generate kubeconfig for CI
  run: |
    chmod +x ./generate-kubeconfig.sh
    ./generate-kubeconfig.sh
  env:
    KUBECONFIG: ./ci-sa.kubeconfig

- name: Deploy with kubectl
  run: |
    kubectl get pods -n ci
  env:
    KUBECONFIG: ./ci-sa.kubeconfig
```

---
