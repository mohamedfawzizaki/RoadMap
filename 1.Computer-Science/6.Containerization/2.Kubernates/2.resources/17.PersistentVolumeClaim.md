___________________________________________________________________________________________________________________________

---

## üì¶ What is a PersistentVolumeClaim (PVC)?

A **PersistentVolumeClaim (PVC)** is a **request for storage** made by a user or a pod. Kubernetes uses PVCs to **bind applications to PersistentVolumes (PVs)**, enabling **persistent storage** beyond pod lifecycles.

> Think of it like a "storage contract" ‚Äî the user asks for space, and Kubernetes finds or creates a disk that satisfies it.

---

## üîó How It Fits in the Storage Workflow

1. **Cluster has PVs** (pre-provisioned or dynamically provisioned)
2. A user creates a **PVC** that specifies:

   * Size
   * Access mode
   * Storage class (optional)
3. Kubernetes **binds** the PVC to a suitable PV.
4. Pods mount the PVC to access storage.

---

## üßæ Basic PVC YAML Example

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-data
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
```

---

## üß© Key Fields in a PVC

| Field                        | Description                                           |
| ---------------------------- | ----------------------------------------------------- |
| `accessModes`                | Desired mount behavior (e.g., read/write access)      |
| `resources.requests.storage` | The amount of storage requested                       |
| `storageClassName`           | Which `StorageClass` to use (optional)                |
| `volumeName`                 | Manually bind to a specific PV (optional)             |
| `volumeMode`                 | `Filesystem` (default) or `Block`                     |
| `selector`                   | Label selector to filter which PVs to bind (optional) |
| `volumeAttributesClassName`  | (Alpha/Beta) Reusable CSI parameters (optional)       |

---

## üîÅ Access Modes

| Mode            | Description                             |
| --------------- | --------------------------------------- |
| `ReadWriteOnce` | One node can read/write (most common)   |
| `ReadOnlyMany`  | Multiple nodes can read, none can write |
| `ReadWriteMany` | Multiple nodes can read and write       |

> Not all backends (e.g., AWS EBS) support all access modes.

---

## üîÑ Volume Binding Modes

Controlled by the StorageClass:

* `Immediate`: PV is provisioned as soon as PVC is created
* `WaitForFirstConsumer`: Waits until pod is scheduled to avoid zone mismatch

---

## ‚úÖ Dynamic vs Static Binding

| Mode        | Description                                                                  |
| ----------- | ---------------------------------------------------------------------------- |
| **Static**  | Admin manually creates PV ‚Üí PVC binds if compatible                          |
| **Dynamic** | PVC requests storage ‚Üí Kubernetes provisions PV on demand via `StorageClass` |

### Dynamic Example:

```yaml
spec:
  storageClassName: fast
```

---

## üìò Full Example: PVC + Pod

### 1. PVC

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: data-pvc
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast
  resources:
    requests:
      storage: 10Gi
```

### 2. Pod

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: mypod
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - mountPath: /usr/share/nginx/html
      name: mydata
  volumes:
  - name: mydata
    persistentVolumeClaim:
      claimName: data-pvc
```

---

## üîç CLI Commands

```bash
kubectl get pvc
kubectl describe pvc my-data
kubectl get pv
```

---

## üß™ Check Binding Status

```bash
kubectl get pvc
```

Look at the `STATUS` column:

* `Pending`: waiting to bind to a PV
* `Bound`: successfully bound
* `Lost`: bound PV is no longer available

---

## üîê PVC Resize (If Supported)

To expand PVC:

1. `StorageClass.allowVolumeExpansion: true`
2. Patch the claim:

```bash
kubectl patch pvc data-pvc -p '{"spec":{"resources":{"requests":{"storage":"20Gi"}}}}'
```

---

## üìã Common Use Cases

| Scenario                      | PVC Usage                                |
| ----------------------------- | ---------------------------------------- |
| MySQL/PostgreSQL database pod | PVC stores database files                |
| Web app storing file uploads  | PVC stores user content                  |
| CI/CD pipelines with cache    | PVC stores intermediate build data       |
| Log aggregators               | PVC stores persistent logs from all runs |

---

## üß± PVC + StatefulSet Example (Brief)

```yaml
volumeClaimTemplates:
- metadata:
    name: data
  spec:
    accessModes: [ "ReadWriteOnce" ]
    storageClassName: fast
    resources:
      requests:
        storage: 1Gi
```

Each pod gets its own PVC ‚Äî `data-0`, `data-1`, etc.

---

## üß† Best Practices

| Practice                                     | Why it‚Äôs important                              |
| -------------------------------------------- | ----------------------------------------------- |
| Use dynamic provisioning via `StorageClass`  | Simplifies operations                           |
| Monitor PVC status                           | Avoid `Pending` and `Lost` states               |
| Use `Retain` reclaimPolicy for critical data | Prevent accidental deletion of underlying PV    |
| Match PVC and PV exactly (if static)         | Size, access mode, SC must match                |
| Use `ReadWriteMany` only when required       | It requires special storage backends (like NFS) |

---

## üìú Summary

| Concept        | Description                                          |
| -------------- | ---------------------------------------------------- |
| PVC            | Request for storage                                  |
| PV             | Actual disk (pre-provisioned or dynamically created) |
| StorageClass   | Defines how to provision PVs                         |
| Binding        | PVC is matched to PV if specs match                  |
| Reclaim Policy | Controls what happens to PV after PVC is deleted     |
| Volume Mode    | Either `Filesystem` (default) or `Block`             |

---

Sure! Here's a **complete example for each** of these cloud storage types‚Äî**AWS EBS**, **Azure Disk**, and **NFS**‚Äîshowing how to use `StorageClass`, `PersistentVolumeClaim`, and a pod that uses the claim.

---

# 1. AWS EBS Example

### StorageClass for AWS EBS (GP2 volume)

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: aws-ebs-gp2
provisioner: ebs.csi.aws.com    # AWS EBS CSI driver
parameters:
  type: gp2
  fsType: ext4
reclaimPolicy: Delete
volumeBindingMode: WaitForFirstConsumer
```

### PersistentVolumeClaim using AWS EBS StorageClass

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ebs-pvc
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: aws-ebs-gp2
  resources:
    requests:
      storage: 10Gi
```

### Pod Using the PVC

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: ebs-pod
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: ebs-storage
      mountPath: /usr/share/nginx/html
  volumes:
  - name: ebs-storage
    persistentVolumeClaim:
      claimName: ebs-pvc
```

---

# 2. Azure Disk Example

### StorageClass for Azure Managed Disk (Premium SSD)

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: azure-disk-premium
provisioner: disk.csi.azure.com   # Azure Disk CSI driver
parameters:
  skuname: Premium_LRS
  kind: Managed
  cachingmode: ReadOnly
reclaimPolicy: Delete
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
```

### PersistentVolumeClaim using Azure Disk StorageClass

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: azure-disk-pvc
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: azure-disk-premium
  resources:
    requests:
      storage: 20Gi
```

### Pod Using the PVC

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: azure-disk-pod
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: azure-storage
      mountPath: /usr/share/nginx/html
  volumes:
  - name: azure-storage
    persistentVolumeClaim:
      claimName: azure-disk-pvc
```

---

# 3. NFS Example

For NFS, you usually **pre-provision a PersistentVolume** because dynamic provisioning requires a CSI driver or provisioner.

### PersistentVolume for NFS

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: nfs-pv
spec:
  capacity:
    storage: 100Gi
  accessModes:
    - ReadWriteMany
  nfs:
    server: 10.0.0.100        # Replace with your NFS server IP
    path: /exports/data
  persistentVolumeReclaimPolicy: Retain
```

### PersistentVolumeClaim for NFS

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nfs-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 50Gi
  volumeName: nfs-pv
```

### Pod Using the NFS PVC

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nfs-pod
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: nfs-storage
      mountPath: /usr/share/nginx/html
  volumes:
  - name: nfs-storage
    persistentVolumeClaim:
      claimName: nfs-pvc
```

---

# Summary

| Cloud Provider | Dynamic Provisioning    | Notes                                |
| -------------- | ----------------------- | ------------------------------------ |
| **AWS EBS**    | Yes (with StorageClass) | `ebs.csi.aws.com` driver required    |
| **Azure Disk** | Yes (with StorageClass) | `disk.csi.azure.com` driver          |
| **NFS**        | Usually manual PV       | Requires an NFS server and static PV |

---