___________________________________________________________________________________________________________________________

---

# What is a DaemonSet?

A **DaemonSet** ensures that a copy of a specific pod runs on **all nodes** (or a subset based on selectors and tolerations) in a Kubernetes cluster.

* Guarantees one pod per node.
* Automatically launches pods on new nodes when they join the cluster.
* Deletes pods when nodes are removed.

---

# Why use DaemonSet?

DaemonSets are used for deploying **node-level** or **cluster-wide** services such as:

* Log collectors (e.g., Fluentd, Logstash)
* Monitoring agents (e.g., Prometheus node exporter)
* Network plugins (e.g., Calico, Weave Net)
* Security agents (e.g., Falco)
* Storage drivers and volume plugins

---

# Key Characteristics

| Feature              | Description                                                       |
| -------------------- | ----------------------------------------------------------------- |
| Pod per node         | One pod runs on each node matching criteria                       |
| Automatic rollout    | New pods created on nodes joining cluster                         |
| Controlled update    | Rolling updates with update strategy                              |
| Selective scheduling | Run on all nodes or a subset via nodeSelector, taints/tolerations |

---

# Anatomy of a DaemonSet YAML

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd
  labels:
    app: fluentd
spec:
  selector:
    matchLabels:
      app: fluentd
  template:
    metadata:
      labels:
        app: fluentd
    spec:
      containers:
      - name: fluentd
        image: fluent/fluentd:v1.12
        resources:
          limits:
            memory: 200Mi
            cpu: 100m
        volumeMounts:
        - name: varlog
          mountPath: /var/log
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
```

---

# Important Fields

| Field            | Description                                                |
| ---------------- | ---------------------------------------------------------- |
| `selector`       | Label selector matching pods managed by this DaemonSet     |
| `template`       | Pod template describing pod to run on each node            |
| `updateStrategy` | Strategy for updating pods (`RollingUpdate` or `OnDelete`) |
| `nodeSelector`   | Limit pods to run only on nodes with matching labels       |
| `tolerations`    | Allow scheduling on nodes with specific taints             |
| `volumes`        | Volumes mounted into pod (often hostPath for node access)  |

---

# Scheduling DaemonSet Pods

* By default, DaemonSet pods run on **all nodes** in the cluster.
* You can restrict which nodes run DaemonSet pods using:

  * **nodeSelector**: Run pods on nodes with matching labels.
  * **node affinity**: More expressive scheduling rules.
  * **tolerations**: Let DaemonSet pods run on tainted nodes.
* Pods respect pod anti-affinity and affinity rules.

---

# Update Strategies

* **RollingUpdate** (default): Updates pods on nodes one-by-one respecting maxUnavailable.
* **OnDelete**: Pods are updated only when manually deleted.

Example:

```yaml
updateStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 1
```

---

# DaemonSet Lifecycle

* When created, DaemonSet schedules pods on all matching nodes.
* When a new node joins, DaemonSet automatically schedules a pod on it.
* When a node is removed, its DaemonSet pod is deleted.
* When updated, DaemonSet rolls out pod updates per strategy.

---

# Use Case Examples

| Use Case       | Description                           |
| -------------- | ------------------------------------- |
| Log Collection | Run Fluentd/Logstash on all nodes     |
| Monitoring     | Deploy Prometheus Node Exporter       |
| Networking     | Deploy CNI plugins like Calico        |
| Security       | Run Falco or security scanning agents |
| Storage        | Deploy storage drivers/CSI plugins    |

---

# Commands

* Create DaemonSet:

```bash
kubectl apply -f daemonset.yaml
```

* Get DaemonSets:

```bash
kubectl get daemonsets
kubectl describe daemonset fluentd
```

* Delete DaemonSet:

```bash
kubectl delete daemonset fluentd
```

---

# Summary Table

| Aspect          | Description                                           |
| --------------- | ----------------------------------------------------- |
| Pods per node   | One pod per matching node                             |
| Scheduling      | All nodes or subset via selectors and tolerations     |
| Update Strategy | RollingUpdate (default) or OnDelete                   |
| Use cases       | Node-level agents for logging, monitoring, networking |

---
Sure! Here are some common **use cases** for Kubernetes **DaemonSets**, highlighting why and when you’d use them:

---

## Common Use Cases for DaemonSet

### 1. **Log Collection Agents**

* **Examples:** Fluentd, Logstash, Filebeat
* **Why:** Collect logs from all nodes’ local files or system logs.
* **How:** DaemonSet runs one logging agent pod on every node, mounting `/var/log` or other host paths to ship logs to centralized storage.

---

### 2. **Monitoring Agents**

* **Examples:** Prometheus Node Exporter, Datadog Agent, New Relic Agent
* **Why:** Collect metrics (CPU, memory, disk, network) from all nodes for cluster monitoring.
* **How:** DaemonSet ensures each node runs a monitoring agent exposing node-level metrics.

---

### 3. **Networking and CNI Plugins**

* **Examples:** Calico, Weave Net, Flannel
* **Why:** Manage pod networking, IP allocation, network policies.
* **How:** DaemonSet deploys networking components on each node to maintain networking overlay and connectivity.

---

### 4. **Security and Compliance Agents**

* **Examples:** Falco, Sysdig, Aqua Security agents
* **Why:** Monitor system calls, enforce security policies, audit logs.
* **How:** DaemonSet runs security agents on each node to observe and react to security events.

---

### 5. **Storage Plugins and CSI Drivers**

* **Examples:** Storage drivers, volume plugins like Ceph, GlusterFS
* **Why:** Manage persistent volumes, volume attachment/detachment.
* **How:** DaemonSet deploys storage driver pods on each node to interface with node storage.

---

### 6. **Cluster DNS or Proxy**

* Sometimes used for DNS cache or proxy agents running on all nodes for network optimizations.

---

### 7. **Custom Node Utilities**

* Custom scripts or utilities that must run on every node, e.g., configuration management, housekeeping, or diagnostics.

---

## Why DaemonSet?

* Ensures **exactly one pod per node** — crucial for node-level services.
* Automatically **scales with cluster size** — pods added to new nodes automatically.
* Supports node filtering to **restrict which nodes run the pod** (e.g., only Linux nodes, or nodes with GPUs).

---
