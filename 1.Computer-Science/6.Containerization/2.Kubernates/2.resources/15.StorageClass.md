___________________________________________________________________________________________________________________________

---

## üì¶ What is a `StorageClass`?

A **`StorageClass`** in Kubernetes defines a **storage backend (type, parameters, and policies)** used by the cluster to dynamically create PersistentVolumes (PVs) when a **PersistentVolumeClaim (PVC)** is created.

> It lets developers simply request storage using a name, and Kubernetes + the underlying CSI driver does the provisioning for you.

---

## üß† Why Use StorageClass?

Without `StorageClass`, you must **pre-provision PVs** manually. With `StorageClass`, you get:

‚úÖ **Dynamic provisioning** of PVs
‚úÖ Different performance/storage profiles (e.g., SSD, HDD, encrypted, etc.)
‚úÖ CSI (Container Storage Interface) support for cloud and on-prem drivers
‚úÖ Automatic deletion or retention based on policy

---

## üßæ Example: A Basic StorageClass

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp2
  fsType: ext4
reclaimPolicy: Delete
volumeBindingMode: WaitForFirstConsumer
```

---

## üîç Key Fields in StorageClass

| Field                  | Description                                         |
| ---------------------- | --------------------------------------------------- |
| `provisioner`          | The CSI or legacy plugin that provisions volumes    |
| `parameters`           | Backend-specific options (e.g., disk type, fs type) |
| `reclaimPolicy`        | `Delete` or `Retain` when PVC is deleted            |
| `volumeBindingMode`    | Controls when the volume is provisioned and bound   |
| `allowVolumeExpansion` | Whether PVC size can be increased                   |
| `mountOptions`         | Optional: passed to the mount command               |

---

## üîß Common Provisioners

| Provisioner (Driver)              | Platform / Provider          |
| --------------------------------- | ---------------------------- |
| `kubernetes.io/aws-ebs`           | AWS EBS                      |
| `kubernetes.io/gce-pd`            | Google Cloud Persistent Disk |
| `kubernetes.io/azure-disk`        | Azure Disk                   |
| `csi.azure.com`                   | Azure CSI                    |
| `csi.aws.com` / `ebs.csi.aws.com` | AWS EBS CSI (modern)         |
| `nfs.csi.k8s.io`                  | NFS CSI                      |
| `local.csi.k8s.io`                | Local disk                   |
| `rook-ceph.rbd.csi.ceph.com`      | Rook/Ceph Block              |

---

## üìò Reclaim Policy

| Policy   | Description                                 |
| -------- | ------------------------------------------- |
| `Delete` | PV and backing storage are deleted with PVC |
| `Retain` | PV is retained for manual reuse             |

---

## üåÄ `volumeBindingMode`

| Mode                   | Behavior                                                                       |
| ---------------------- | ------------------------------------------------------------------------------ |
| `Immediate`            | Default. Volume created as soon as PVC is created.                             |
| `WaitForFirstConsumer` | Delays provisioning until a Pod is scheduled. Ensures zone/availability match. |

---

## üå± Enabling Dynamic Provisioning

1. Define a `StorageClass`
2. Create a `PersistentVolumeClaim` referencing the class
3. Kubernetes auto-creates and binds a PersistentVolume for that PVC

---

## üßæ PVC Example using StorageClass

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-dynamic-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: fast
```

When this PVC is created, Kubernetes will:

* Use `StorageClass: fast`
* Call the provisioner (e.g., AWS EBS)
* Create a PV and bind it to this claim

---

## üìò Default StorageClass

You can designate one `StorageClass` as the **default** using this annotation:

```yaml
metadata:
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
```

To view the default:

```bash
kubectl get storageclass
```

---

## üîç Inspect StorageClasses

```bash
kubectl get storageclass
kubectl describe storageclass standard
```

---

## ‚úÖ Best Practices

| Practice                                            | Why it matters                                     |
| --------------------------------------------------- | -------------------------------------------------- |
| Use `WaitForFirstConsumer` for zonal storage        | Prevents provisioning in wrong zone                |
| Name classes by usage (`fast`, `slow`, `encrypted`) | Improves clarity                                   |
| Set a default `StorageClass`                        | Helps developers get dynamic storage automatically |
| Avoid hostPath in production                        | Not portable, not secure                           |

---

## üîê Advanced: Enabling Volume Expansion

```yaml
allowVolumeExpansion: true
```

Then, update PVC size:

```yaml
kubectl patch pvc my-dynamic-pvc -p '{"spec":{"resources":{"requests":{"storage":"20Gi"}}}}'
```

Requires support in underlying provisioner.

---

## üì¶ Full Example: SC + PVC + Pod

### 1. StorageClass

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp2
reclaimPolicy: Delete
volumeBindingMode: WaitForFirstConsumer
```

### 2. PVC

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-fast
spec:
  accessModes: [ "ReadWriteOnce" ]
  resources:
    requests:
      storage: 5Gi
  storageClassName: fast
```

### 3. Pod using PVC

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: app-using-pvc
spec:
  containers:
  - name: myapp
    image: nginx
    volumeMounts:
    - mountPath: /usr/share/nginx/html
      name: storage
  volumes:
  - name: storage
    persistentVolumeClaim:
      claimName: pvc-fast
```

---

## üìú Summary

| Field                  | Description                                  |
| ---------------------- | -------------------------------------------- |
| `StorageClass`         | Defines how to dynamically provision storage |
| `provisioner`          | Driver/plugin to use                         |
| `parameters`           | Custom options (disk type, etc.)             |
| `reclaimPolicy`        | Retain or delete storage on PVC delete       |
| `volumeBindingMode`    | When to provision PV                         |
| `allowVolumeExpansion` | Whether PVC can be resized                   |

---
