___________________________________________________________________________________________________________________________

---

# What is a Deployment?

A **Deployment** is a Kubernetes controller that provides declarative updates for Pods and ReplicaSets.

* It manages the creation and scaling of **ReplicaSets**.
* Supports **rolling updates** to update pods with zero downtime.
* Handles **rollback** to previous versions if needed.
* Provides declarative **desired state** management for your applications.

---

# Why use a Deployment?

* Declaratively define your app’s desired state (pods, replicas, versions).
* Perform **rolling updates** without downtime.
* Roll back to previous versions easily.
* Scale your app up or down smoothly.
* Manage the lifecycle of ReplicaSets and Pods automatically.

---

# Anatomy of a Deployment YAML

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-deployment
  labels:
    app: myapp
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: my-container
        image: nginx:1.21
        ports:
        - containerPort: 80
```

---

# Key Fields Explained

| Field                  | Description                                                                                 |
| ---------------------- | ------------------------------------------------------------------------------------------- |
| `replicas`             | Number of pod replicas desired                                                              |
| `selector`             | Label selector to identify pods managed by this Deployment (must match pod template labels) |
| `strategy`             | Update strategy (`RollingUpdate` or `Recreate`)                                             |
| `template`             | Pod template describing pods to be created                                                  |
| `minReadySeconds`      | Time pod must be ready before considered available                                          |
| `revisionHistoryLimit` | Number of old ReplicaSets to keep for rollback                                              |
| `paused`               | Boolean to pause rollout temporarily                                                        |

---

# Deployment Strategies

### 1. RollingUpdate (default)

* Gradually replace old pods with new pods.
* Parameters:

  * `maxUnavailable`: How many pods can be unavailable during update (number or percentage).
  * `maxSurge`: How many extra pods can be created during update.

Example:

```yaml
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 1
    maxSurge: 1
```

---

### 2. Recreate

* Deletes all existing pods before creating new ones.
* Causes downtime but sometimes necessary for incompatible changes.

```yaml
strategy:
  type: Recreate
```

---

# Deployment Lifecycle and Behavior

* When you create a Deployment, it creates a **ReplicaSet**.
* The ReplicaSet manages pods with the specified labels.
* On update (e.g., change image tag), Deployment creates a **new ReplicaSet** with new pod template.
* The old ReplicaSet is scaled down as the new ReplicaSet is scaled up (according to strategy).
* You can **roll back** to previous ReplicaSets.

---

# Rollbacks

* Automatically keeps history of previous ReplicaSets.
* Rollback command:

```bash
kubectl rollout undo deployment/my-deployment
```

* Rollback to a specific revision with:

```bash
kubectl rollout undo deployment/my-deployment --to-revision=2
```

---

# Pausing and Resuming Deployment

* Pause updates to Deployment:

```bash
kubectl rollout pause deployment/my-deployment
```

* Resume updates:

```bash
kubectl rollout resume deployment/my-deployment
```

Useful for batching changes or manual approval.

---

# Pod Management Features in Deployment

* Supports **readiness probes** — controls when pods are considered ready to serve traffic.
* Supports **liveness probes** — restarts unhealthy containers.
* Supports **resource requests/limits** — for scheduling and QoS.
* Supports **environment variables**, **volumes**, **affinity**, **tolerations**, and more.

---

# Status and Monitoring

Check rollout status:

```bash
kubectl rollout status deployment/my-deployment
```

Get detailed status:

```bash
kubectl describe deployment my-deployment
```

---

# Example: Advanced Deployment with resource limits, probes, and affinity

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: advanced-deployment
spec:
  replicas: 4
  selector:
    matchLabels:
      app: advanced-app
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 2
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app: advanced-app
    spec:
      containers:
      - name: app-container
        image: myapp:2.0
        resources:
          requests:
            memory: "256Mi"
            cpu: "500m"
          limits:
            memory: "512Mi"
            cpu: "1"
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
        livenessProbe:
          httpGet:
            path: /live
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - advanced-app
            topologyKey: "kubernetes.io/hostname"
```

---

# Commands Summary

| Command                                        | Description                   |
| ---------------------------------------------- | ----------------------------- |
| `kubectl apply -f deployment.yaml`             | Create or update Deployment   |
| `kubectl get deployments`                      | List Deployments              |
| `kubectl describe deployment <name>`           | Show detailed Deployment info |
| `kubectl rollout status deployment/<name>`     | Monitor rollout progress      |
| `kubectl rollout undo deployment/<name>`       | Rollback to previous version  |
| `kubectl scale deployment/<name> --replicas=N` | Scale number of replicas      |
| `kubectl rollout pause deployment/<name>`      | Pause rollout                 |
| `kubectl rollout resume deployment/<name>`     | Resume rollout                |

---

# Summary Table

| Aspect                   | Description                                    |
| ------------------------ | ---------------------------------------------- |
| Manages ReplicaSets      | Automates pod lifecycle and replica management |
| Supports Rolling Updates | Zero downtime deployments                      |
| Declarative Updates      | Define desired state and let controller manage |
| Rollbacks                | Easy revert to previous versions               |
| Update Strategies        | RollingUpdate (default), Recreate              |
| Pod Template             | Defines pods created and managed by Deployment |

---
